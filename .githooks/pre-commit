#!/bin/bash

# Pre-commit hook for Lapis
# This script runs Ameba before allowing commits

echo "ğŸ” Running Ameba linter..."

# Change to project root
cd "$(git rev-parse --show-toplevel)"

# Check if ameba binary exists
if [ ! -f "./bin/ameba" ]; then
    echo "âŒ Ameba binary not found. Run 'shards install' first."
    exit 1
fi

# Run ameba on staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.cr$' || true)

if [ -z "$staged_files" ]; then
    echo "âœ… No Crystal files staged for commit."
    exit 0
fi

echo "ğŸ“ Checking staged files: $staged_files"

# Run ameba on staged files
./bin/ameba $staged_files

# Check exit code
if [ $? -eq 0 ]; then
    echo "âœ… Ameba checks passed!"
    exit 0
else
    echo "âŒ Ameba found issues. Please fix them before committing."
    echo "ğŸ’¡ Run './bin/ameba --fix' to auto-fix some issues."
    exit 1
fi
